import{O as Me,d as pe,r as V,H as xe,j as D,o as R,z as q,w as g,h as r,m as M,f,J as le,C as J,_ as fe,c as ne,B as re,Z as Le,K as Ne,e as te,D as Oe,R as Ye,p as $e,n as ke,F as ie,y as ce,g as de,t as j,x as Re,I as ue}from"./index-CS97xECk.js";import{i as Ue}from"./index-Bwm8AFsF.js";import{d as Ge}from"./fault-4m_H0PCC.js";import{a as Be,G as We}from"./wokingtion-B2wKtcAy.js";const Fe=t=>{const s=new URLSearchParams;s.append("token",t.token),s.append("page",t.page),s.append("pageSize",t.pageSize),console.log(t.lI_DTUID);const L={WAVEID:t.waveid,GPSTIME:t.gpstime,WAVETYPE:t.wavetype,EN_GPS:t.eN_GPS,EN_PPS:t.eN_PPS,DTUID:t.dtuid,DBTIME:t.dbtime,OVERTIME:t.overtime,CO_TSEG:t.cO_TSEG,CO_SCALE:t.cO_SCALE,ABOFFSET:t.aboffset,PRETRIPOINTS:t.pretripoints,SLTYPE:t.sltype,TOTALPOINTS:t.totalpoints,SAMPRATE:t.samprate,WAVEDATASTATE:t.wavedatastate,REPORTTYPE:t.reporttype,DISPOSEFLAG:t.disposeflag,MAXVALUE:t.maxvalue,MAXEVALUE:t.maxvalue,DISPOSEVLAUE:t.disposevlaue,WARNINGFLAG:t.warningflag,WAVECATEGORY:t.wavecategory,BITORDER:t.bitorder,ISSIGNBIT:t.issignbit,RATIOVALUE:t.ratiovalue,CALIBRATE:t.calibrate,NETMLINEID:t.netMlineid,MLINEID:t.mlineid,LI_DTUID:(t.lI_DTUID,t.lI_DTUID),STime:t.sTime,ETime:t.eTime};return Me.post(`/api/Wave/GetWaveList?${s.toString()}`,L)};var H=(t=>(t[t.行波电流=1]="行波电流",t[t.行波电压=2]="行波电压",t[t.工频故障电流=3]="工频故障电流",t[t.工频故障电压=4]="工频故障电压",t[t.隐患行波电流=5]="隐患行波电流",t[t.全部=99]="全部",t))(H||{}),ve=(t=>(t[t.低增益=1]="低增益",t[t.高增益=2]="高增益",t[t.无增益=0]="无增益",t))(ve||{}),ge=(t=>(t[t.A相=1]="A相",t[t.B相=2]="B相",t[t.C相=3]="C相",t[t.零序=4]="零序",t[t.合体=99]="合体",t[t.无=0]="无",t))(ge||{}),Z=(t=>(t[t.触发上报=1]="触发上报",t[t.自检上报=2]="自检上报",t[t.召回上报=3]="召回上报",t[t.全部=99]="全部",t))(Z||{});const ze=pe({__name:"WaveChartViewer",emits:["close"],setup(t,{expose:s,emit:L}){const I=V(null),Y=V(!1),P={waveform:null},G=L,W=async i=>{if(!i||i.length===0)return;Y.value=!0;const _={token:le.get("Token"),waveid:i,sTime:new Date().toISOString(),eTime:new Date().toISOString()},v=await Ge(_);if(v.Code=="1"){const d=JSON.parse(v.Message),E=[],w=[];d.forEach(h=>{h.WAVETYPE===3||h.WAVETYPE===4?E.push(h):(h.WAVETYPE===1||h.WAVETYPE===2)&&w.push(h)});const A=b(E,"milliseconds"),p=b(w,"microseconds"),m={xAxis:[],series:[]},S={xAxis:[],series:[]};A.forEach(h=>{m.xAxis.push(h.TimeSeries.map(y=>y.toString().replace(/(\.\d{2})\d*/,"$1"))),m.series.push(h.WaveData)}),p.forEach(h=>{S.xAxis.push(h.TimeSeries.map(y=>y.toString().replace(/(\.\d{2})\d*/,"$1"))),S.series.push(h.WaveData)}),await J(),C(),X(m,S)}},X=(i,u)=>{const _=I.value;if(!_)return;let v=u.series.length>0?u:i.series.length>0?i:null;if(!v)return;const d=u.series.length>0?"行波电流":"工频电流",E=d==="行波电流"?"#FF5733":"#3357FF",w=Array.from(new Set(v.xAxis.flat())).sort((m,S)=>parseFloat(m)-parseFloat(S)),A=v.series.map((m,S)=>{const h=new Map;return v.xAxis[S].forEach((y,$)=>{h.set(y,m[$])}),w.map(y=>h.get(y)??null)}),p=Ue(_);p.setOption({title:{text:d,textStyle:{color:"#000"}},tooltip:{trigger:"axis"},grid:{left:"5%",right:"5%",top:"12%",bottom:"15%",containLabel:!0},xAxis:{type:"category",data:w,name:"时间",axisLine:{lineStyle:{color:"#000"}}},yAxis:{type:"value",axisLine:{lineStyle:{color:"#000"}},axisLabel:{color:"#666"}},series:A.map((m,S)=>({name:`${d} 曲线 ${S+1}`,type:"line",data:m,smooth:!0,connectNulls:!0,lineStyle:{width:2,color:S%2===0?E:"#0000ff"},itemStyle:{color:S%2===0?E:"#0000ff"}}))}),P.waveform=p},C=()=>{P.waveform&&(P.waveform.dispose(),P.waveform=null)},O=()=>{C(),G("close")},b=(i,u)=>{if(i.length===0)return[];let _=BigInt(0);return i.forEach(v=>{const d=K(v.GPSTime,v.PretriPoints*1e9/v.Samprate);v.startTime=d,(_===BigInt(0)||d<_)&&(_=d)}),i.forEach(v=>{let d=k(v.startTime.toString(),_.toString());if(d!==0){u==="microseconds"&&(d*=1e3);for(let E=0;E<v.TimeSeries.length;E++)v.TimeSeries[E]+=d}}),i};function K(i,u){let _=BigInt(0);if(i){let d=(p=>{const m=p.slice(0,4),S=p.slice(4,6),h=p.slice(6,8),y=p.slice(8,10),$=p.slice(10,12),F=p.slice(12,14),z=p.slice(14,17);return new Date(`${m}-${S}-${h}T${y}:${$}:${F}.${z}Z`)})(i.slice(0,17)),E=Math.floor(u/1e6);d=new Date(d.getTime()-E),u=u-E*1e6;let w=parseInt(i.slice(17))-u;w<0&&(d=new Date(d.getTime()-1),w+=1e6),_=BigInt(`${(p=>{const m=S=>S.toString().padStart(2,"0");return`${p.getUTCFullYear()}${m(p.getUTCMonth()+1)}${m(p.getUTCDate())}${m(p.getUTCHours())}${m(p.getUTCMinutes())}${m(p.getUTCSeconds())}${p.getUTCMilliseconds().toString().padStart(3,"0")}`})(d)}${w.toString().padStart(6,"0")}`)}return _}function k(i,u){if(!i||!u)return 0;BigInt(u)>BigInt(i)&&([i,u]=[u,i]);const _=A=>{const p=A.slice(0,4),m=A.slice(4,6),S=A.slice(6,8),h=A.slice(8,10),y=A.slice(10,12),$=A.slice(12,14),F=A.slice(14,17);return new Date(`${p}-${m}-${S}T${h}:${y}:${$}.${F}Z`)},v=_(i.slice(0,17)),d=_(u.slice(0,17)),E=v.getTime()-d.getTime();let w=parseInt(i.slice(17))-parseInt(u.slice(17));return w<0?E-1+(w+1e6)/1e6:E+w/1e6}return xe(()=>{C()}),s({open:W}),(i,u)=>{const _=D("el-button"),v=D("el-dialog");return R(),q(v,{modelValue:Y.value,"onUpdate:modelValue":u[1]||(u[1]=d=>Y.value=d),title:"波形图",width:"80%",top:"5vh","destroy-on-close":"",onClose:O,class:"wave-dialog"},{footer:g(()=>[r(_,{onClick:u[0]||(u[0]=d=>Y.value=!1)},{default:g(()=>[M("关闭")]),_:1})]),default:g(()=>[f("div",{class:"waveform-chart",ref_key:"waveformChart",ref:I},null,512)]),_:1},8,["modelValue"])}}}),je=fe(ze,[["__scopeId","data-v-c5c1f942"]]),U=t=>($e("data-v-1892e76c"),t=t(),ke(),t),He={class:"waveform-container"},Xe={class:"filter-area"},qe={class:"search_top"},Je={class:"flexStyle"},Ze=U(()=>f("div",{class:"labelStyle"},"线路：",-1)),Ke={class:"flexStyle"},Qe=U(()=>f("div",{class:"labelStyle"},"复杂线路：",-1)),et={class:"flexStyle"},tt=U(()=>f("div",{class:"labelStyle"},"终端编号：",-1)),lt={style:{display:"flex"}},ot={class:"flexStyle"},at=U(()=>f("div",{class:"labelStyle"},"波形编号：",-1)),st={class:"flexStyle"},nt=U(()=>f("div",{class:"labelStyle"},"波形类型：",-1)),rt={class:"flexStyle"},it=U(()=>f("div",{class:"labelStyle"},"上报类型",-1)),ct={class:"flexStyle timeStyle"},dt=U(()=>f("div",{class:"labelStyle"},"时间范围：",-1)),ut={class:"searchButton"},pt={class:"batch-input-content"},ft={class:"table-area"},vt={style:{width:"100%",height:"50px","overflow-x":"auto","min-height":"50px","white-space":"nowrap"}},gt=pe({__name:"index",setup(t){const s=ne({selectedLine:"",showOnlyTopLevel:!1,deviceId:"",waveId:"",waveType:H.全部,reportType:Z.全部,timeRange:[]}),L=V(),I=V([]),Y=V([]),P=V([]),G=V(!1),W=V(!1),X=V(),C=V(!1),O=V(!1),b=ne({currentPage:1,pageSize:10,total:0}),K=V({label:"MLNAME",value:"MLINEID"}),k=V(!1),i=V(""),u=Object.entries(H).filter(([l,e])=>typeof e=="number").map(([l,e])=>({label:l,value:e})),_=Object.entries(Z).filter(([l,e])=>typeof e=="number").map(([l,e])=>({label:l,value:e})),v=Object.entries(ge).filter(([l,e])=>typeof e=="number").map(([l,e])=>({label:l,value:e})),d=l=>{var e;return((e=v.find(o=>o.value===l))==null?void 0:e.label)||l},E=Object.entries(ve).filter(([l,e])=>typeof e=="number").map(([l,e])=>({label:l,value:e})),w=l=>{var e;return((e=E.find(o=>o.value===l))==null?void 0:e.label)||l},A=()=>{k.value=!0,i.value=s.deviceId.split(",").join(`
`)},p=()=>{const l=i.value.split(`
`).map(e=>e.trim()).filter(e=>e.length>0).join(",");s.deviceId=l,k.value=!1},m=Object.entries(H).filter(([l,e])=>typeof e=="number").reduce((l,[e,o])=>(l[o]=e,l),{}),S=l=>m[l]||l.toString(),h=()=>{if(I.value.length===0){J(()=>{var o;(o=L.value)==null||o.clearSelection()});return}const l=I.value[0].WAVETYPE,e=P.value.filter(o=>o.WAVETYPE===l&&o.WAVETYPE!==5);J(()=>{var o;(o=L.value)==null||o.clearSelection(),e.forEach(c=>{var T;(T=L.value)==null||T.toggleRowSelection(c,!0)})})},y=async()=>{G.value=!0;try{const l=le.get("Token"),e=s.deviceId?s.deviceId.split(",").map(T=>T.trim()).filter(T=>T!==""):[],o={token:l,waveid:s.waveId,sTime:oe(s.timeRange[0]),eTime:oe(s.timeRange[1]),page:String(b.currentPage),pageSize:String(b.pageSize),netMlineid:s.showOnlyTopLevel?s.selectedLine:"",mlineid:s.showOnlyTopLevel?"":s.selectedLine,lI_DTUID:e||null,gpstime:"",wavetype:s.waveType,eN_GPS:0,eN_PPS:0,dtuid:"",dbtime:"0001-01-01T00:00:00",overtime:"0001-01-01T00:00:00",cO_TSEG:0,cO_SCALE:0,aboffset:0,pretripoints:0,sltype:0,totalpoints:0,samprate:0,wavedatastate:0,reporttype:s.reportType,disposeflag:0,maxvalue:0,maxevalue:0,disposevlaue:0,warningflag:0,wavecategory:0,bitorder:0,issignbit:0,ratiovalue:0,calibrate:0},c=await Fe(o);if(c.Code===1){const T=JSON.parse(c.Message);P.value=T.map(n=>({MLName:n.MLName,waveId:n.WAVEID,ElepoName:n.ElepoName,DTUID:n.DTUID,GPSTIME:n.GPSTIME,SLTYPE:(n.SLTYPE!=99,n.SLTYPE),EN_GPS:n.EN_GPS===0?"无效":"有效",WAVETYPE:n.WAVETYPE,REPORTTYPE:n.REPORTTYPE,DBTIME:n.DBTIME,OVERTIME:n.OVERTIME,CO_SCALE:n.CO_SCALE,TOTALPOINTS:n.TOTALPOINTS,MAXVALUE:n.MAXVALUE,Total:n.Total})),b.total=T.length>0?T[0].Total:0,P.value=Array.from(new Set(T.map(n=>n.WAVEID))).map(n=>T.find(x=>x.WAVEID===n))}}catch(l){console.error("获取波形数据失败:",l)}finally{G.value=!1}},$=()=>{b.currentPage=1,y()},F=()=>{Object.assign(s,{selectedLine:"",showOnlyTopLevel:!1,deviceId:"",waveId:"",waveType:H.全部,reportType:Z.全部,timeRange:ae()}),W.value=!0,z(),$()},z=async()=>{const l=le.get("Token");try{let e;if(s.showOnlyTopLevel?e=await Be(l):e=await We(l),e.Code===1){const o=JSON.parse(e.Message);Y.value=o.map(c=>({MLINEID:c.MLINEID||c.NETMLINEID,MLNAME:c.MLNAME||c.NETMLNAME})),console.log(Y.value),W.value=!0}}catch(e){console.error("获取线路失败:",e)}},oe=l=>{const e=new Date(l),o=e.getFullYear(),c=(e.getMonth()+1).toString().padStart(2,"0"),T=e.getDate().toString().padStart(2,"0"),n=e.getHours().toString().padStart(2,"0"),x=e.getMinutes().toString().padStart(2,"0"),B=e.getSeconds().toString().padStart(2,"0");return`${o}-${c}-${T}T${n}:${x}:${B}`},me=l=>{if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}$/.test(l))return l;const o=l.slice(0,4),c=l.slice(4,6),T=l.slice(6,8),n=l.slice(8,10),x=l.slice(10,12),B=l.slice(12,14),ee=l.slice(14,17);return`${o}-${c}-${T} ${n}:${x}:${B}.${ee}`},he=l=>{l?s.selectedLine=l:s.selectedLine=""};re(I,l=>{const e=P.value.filter(o=>Q(o));l.length===0?(C.value=!1,O.value=!1):l.length===e.length?(C.value=!0,O.value=!1):(C.value=!1,O.value=!0)});const Te=l=>{var e,o;if(l&&I.value.length===0){C.value=!1;return}if(l){const c=(e=I.value[0])==null?void 0:e.WAVETYPE;P.value.filter(n=>n.WAVETYPE===c&&n.WAVETYPE!==5).forEach(n=>{var x;(x=L.value)==null||x.toggleRowSelection(n,!0)})}else(o=L.value)==null||o.clearSelection()},_e=l=>{I.value=l;const e=P.value.filter(o=>Q(o));l.length===0?(C.value=!1,O.value=!1):l.length===e.length?(C.value=!0,O.value=!1):(C.value=!1,O.value=!0)},Se=()=>{console.log("波形图弹窗关闭")},Q=l=>{if(l.WAVETYPE===5)return!1;if(I.value.length===0)return!0;const e=I.value.map(o=>o.WAVETYPE);if(l.WAVETYPE===1||l.WAVETYPE===2)return e.every(o=>o===1||o===2);if(l.WAVETYPE===3||l.WAVETYPE===4)return e.every(o=>o===3||o===4)},Ee=Le(()=>{if(I.value.length===0)return!0;const l=I.value.map(c=>c.WAVETYPE),e=l.every(c=>c===1||c===2),o=l.every(c=>c===3||c===4);return e||o}),Ie=()=>{var e;if(I.value.length===0)return;const[l]=I.value.reduce(([o],c)=>(o.push(c.WAVEID),[o]),[[]]);(e=X.value)==null||e.open(l)},ye=async()=>{W.value=!1,await z()},we=l=>{b.pageSize=l,y()},De=l=>{b.currentPage=l,y()},ae=()=>{const l=new Date,e=new Date;return e.setHours(0,0,0,0),l.setHours(23,59,59,999),[e.toISOString(),l.toISOString()]};return re(()=>s.timeRange,l=>{if(!l||l.length===0){const e=ue().endOf("day"),o=ue().startOf("day");J(()=>{s.timeRange=[o.format("YYYY-MM-DD HH:mm:ss"),e.format("YYYY-MM-DD HH:mm:ss")]})}},{immediate:!0}),Ne(()=>{s.timeRange=ae(),z(),y()}),(l,e)=>{const o=D("el-tree-select"),c=D("el-checkbox"),T=D("el-input"),n=D("el-button"),x=D("el-option"),B=D("el-select"),ee=D("el-date-picker"),se=D("el-tooltip"),be=D("el-alert"),Ae=D("el-dialog"),N=D("el-table-column"),Ve=D("el-table"),Pe=D("el-pagination"),Ce=Ye("loading");return R(),te("div",He,[f("div",Xe,[f("div",qe,[f("div",Je,[Ze,r(o,{modelValue:s.selectedLine,"onUpdate:modelValue":e[0]||(e[0]=a=>s.selectedLine=a),data:Y.value,props:K.value,"value-key":"MLINEID",placeholder:"请输入线路名称搜索",onChange:he,clearable:"","check-strictly":"",filterable:""},null,8,["modelValue","data","props"])]),f("div",Ke,[Qe,r(c,{modelValue:s.showOnlyTopLevel,"onUpdate:modelValue":e[1]||(e[1]=a=>s.showOnlyTopLevel=a),onChange:ye},{default:g(()=>[M(" 是 ")]),_:1},8,["modelValue"])]),f("div",et,[tt,f("div",lt,[r(T,{modelValue:s.deviceId,"onUpdate:modelValue":e[2]||(e[2]=a=>s.deviceId=a),placeholder:"请输入终端编号（支持批量输入）",clearable:""},null,8,["modelValue"]),r(n,{type:"primary",plain:"",onClick:A,class:"batch-btn"},{default:g(()=>[M(" 批量输入 ")]),_:1})])]),f("div",ot,[at,r(T,{modelValue:s.waveId,"onUpdate:modelValue":e[3]||(e[3]=a=>s.waveId=a),placeholder:"请输入波形编号",clearable:""},null,8,["modelValue"])]),f("div",st,[nt,r(B,{modelValue:s.waveType,"onUpdate:modelValue":e[4]||(e[4]=a=>s.waveType=a),placeholder:"请选择波形类型"},{default:g(()=>[(R(!0),te(ie,null,ce(de(u),a=>(R(),q(x,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),f("div",rt,[it,r(B,{modelValue:s.reportType,"onUpdate:modelValue":e[5]||(e[5]=a=>s.reportType=a),placeholder:"请选择上报类型"},{default:g(()=>[(R(!0),te(ie,null,ce(de(_),a=>(R(),q(x,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),f("div",ct,[dt,r(se,{content:"若不选择时间，默认查询最近1天",placement:"top"},{default:g(()=>[r(ee,{modelValue:s.timeRange,"onUpdate:modelValue":e[6]||(e[6]=a=>s.timeRange=a),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})])]),f("div",ut,[r(n,{type:"primary",disabled:I.value.length===0||!Ee.value,onClick:Ie,class:"handlebutton"},{default:g(()=>[M(" 查看波形 ")]),_:1},8,["disabled"]),f("div",null,[r(n,{type:"primary",loading:G.value,onClick:$,class:"querybutton"},{default:g(()=>[M(" 查询 ")]),_:1},8,["loading"]),r(n,{onClick:F,class:"resetbutton"},{default:g(()=>[M("清空")]),_:1})])]),r(Ae,{modelValue:k.value,"onUpdate:modelValue":e[9]||(e[9]=a=>k.value=a),title:"批量输入终端编号",width:"50%","close-on-click-modal":!1},{footer:g(()=>[r(n,{onClick:e[8]||(e[8]=a=>k.value=!1)},{default:g(()=>[M("取消")]),_:1}),r(n,{type:"primary",onClick:p},{default:g(()=>[M("确认")]),_:1})]),default:g(()=>[f("div",pt,[r(be,{title:"每行输入一个终端编号，系统会自动处理格式问题，逗号也会自动进行换行",type:"info","show-icon":"",closable:!1,class:"tip-alert"}),r(T,{modelValue:i.value,"onUpdate:modelValue":e[7]||(e[7]=a=>i.value=a),type:"textarea",rows:10,placeholder:"请输入终端编号，每行一个",resize:"none"},null,8,["modelValue"])])]),_:1},8,["modelValue"])]),f("div",ft,[Oe((R(),q(Ve,{data:P.value,"row-key":"waveid",onSelectionChange:_e,onSelectAll:h,ref_key:"tableRef",ref:L,style:{width:"100%"},height:"65vh","scrollbar-always-on":"true"},{default:g(()=>[r(N,{type:"selection",width:"55",selectable:Q},{header:g(()=>[r(c,{"v-model":C.value,indeterminate:O.value,onChange:Te},null,8,["v-model","indeterminate"])]),_:1}),r(N,{prop:"MLName",label:"线路",width:"250"}),r(N,{prop:"ElepoName",label:"杆塔",width:"120"}),r(N,{prop:"DTUID",label:"终端编号",width:"200"}),r(N,{prop:"SLTYPE",label:"相别",width:"100"},{default:g(({row:a})=>[M(j(d(a.SLTYPE)),1)]),_:1}),r(N,{prop:"GPSTIME",label:"GPS时间",width:"240"},{default:g(({row:a})=>[M(j(a.EN_GPS===0?a.DBTIME.replace("T"," "):me(a.GPSTIME)),1)]),_:1}),r(N,{prop:"EN_GPS",label:"GPS有效性",width:"120"},{default:g(({row:a})=>[f("span",null,j(a.EN_GPS===1?"有效":"无效"),1)]),_:1}),r(N,{prop:"WAVETYPE",label:"波形类型",width:""},{default:g(({row:a})=>[M(j(S(a.WAVETYPE)),1)]),_:1}),r(N,{prop:"CO_SCALE",label:"通道号",width:""},{default:g(({row:a})=>[M(j(w(a.CO_SCALE)),1)]),_:1}),r(N,{prop:"MAXVALUE",label:"幅值",width:""}),Re("",!0)]),_:1},8,["data"])),[[Ce,G.value]])]),f("div",vt,[r(Pe,{"current-page":b.currentPage,"onUpdate:currentPage":e[10]||(e[10]=a=>b.currentPage=a),"page-size":b.pageSize,"onUpdate:pageSize":e[11]||(e[11]=a=>b.pageSize=a),total:b.total,"page-sizes":[10,20,50,100],layout:"prev, pager, next, jumper, ->, sizes, total",onSizeChange:we,onCurrentChange:De,"pager-count":3},null,8,["current-page","page-size","total"])]),r(je,{ref_key:"waveChartRef",ref:X,onClose:Se},null,512)])}}}),St=fe(gt,[["__scopeId","data-v-1892e76c"]]);export{St as default};
