import{d as W,r as E,c as H,K as Q,B as j,e as Z,f as T,h as c,g as v,w as M,D as q,z as G,J as R,j as h,R as X,o as _,S as ee,m as te,t as ae,U as ne,x as oe,V as re,_ as le}from"./index-CS97xECk.js";import{g as se,G as ce,a as ie,b as ue}from"./wokingtion-B2wKtcAy.js";import{a as Ee}from"./line-r0x5eg2L.js";const de={class:"container"},fe={class:"tree-container"},he={class:"table-container"},pe={class:"search"},Ne=W({__name:"workcontion",setup(Ie){const D=E(null),u=E([]),g=E([]),p=E(""),N=E([new Date(new Date().getTime()-7*24*3600*1e3),new Date]),i=H({currentPage:1,pageSize:20,total:0}),d=E(!1),L=E(""),S=E(""),V={children:"children",label:"ELEOFFNAME"};function b(n){const e={},a=[];return n.forEach(t=>{t.IsPELEOFFID=!0,e[t.ELEOFFID]={...t,children:[]}}),n.forEach(t=>{const{ELEOFFID:r,PELEOFFID:l}=t;l&&e[l].children?e[l].children.push(e[r]):a.push(e[r])}),a}function O(n){const e=[],a=new Map;return n.forEach(t=>{if(!t.NETMLINEID||!t.PELEOFFID){e.push(t);return}if(a.has(t.NETMLINEID)){const r=a.get(t.NETMLINEID);r.children=[...r.children,...t.children]}else a.set(t.NETMLINEID,t),e.push(t)}),e.map(t=>{var r;return{...t,children:((r=t.children)==null?void 0:r.length)>0?O(t.children):[]}})}function x(n,e){e.forEach(a=>{C(n,a.NETMLINEID,!0).forEach(r=>{const l={ELEOFFID:a.NETMLINEID,ELEOFFNAME:a.NETMLNAME,PELEOFFID:r.PELEOFFID,ELEOFFEVEL:2,children:[],IsPELEOFFID:!1,NETMLINEID:a.NETMLINEID,MLINEID:a.NETMLINEID};r.NETMLINEID="",l.children.push(r),P(r,n);const s=F(n,l.PELEOFFID);s?(s.children||(s.children=[]),s.children.push(l)):n.push(l)})})}function P(n,e){for(let a=0;a<e.length;a++)if(e[a].children&&e[a].children.length>0){const t=e[a].children.indexOf(n);if(t!==-1){e[a].children.splice(t,1);return}P(n,e[a].children)}}function C(n,e,a){const t=[];return n.forEach(r=>{if(!r.matched&&((r.NETMLINEID===e||!a)&&(t.push(r),r.matched=!0),r.children&&r.children.length>0&&!r.matched)){const l=C(r.children,e,a);t.push(...l),l.forEach(s=>{s!==r&&(s.matched=!0)})}}),t}async function y(){const n=R.get("Token");try{const e=await se(n);if(e.Code===1&&e.Message){const l=JSON.parse(e.Message);u.value=b(l)}const a=await ce(n);a.Code===1&&a.Message&&JSON.parse(a.Message).forEach(s=>{const o={ELEOFFID:s.MLINEID,ELEOFFNAME:s.MLNAME,PELEOFFID:s.ELEOFFID,ELEOFFEVEL:s.SPLITS,children:[],IsPELEOFFID:!1,NETMLINEID:void 0,MLINEID:s.MLINEID};w(u.value,o,s.ELEOFFID)});const t=await Ee(n);t.Code===1&&t.Message&&JSON.parse(t.Message).forEach(s=>{const o=F(u.value,s.MLINEID);o&&(o.NETMLINEID=s.NETMLINEID)});const r=await ie(n);if(r.Code===1&&r.Message){const l=JSON.parse(r.Message);x(u.value,l),u.value=O(u.value)}}catch(e){console.error("Error fetching data",e)}}function A(n){n.forEach(e=>{e.matched=!1,A(e.children)})}function F(n,e){for(const a of n){if(a.ELEOFFID===e)return a;if(a.children){const t=F(a.children,e);if(t)return t}}return null}function w(n,e,a){for(const t of n){if(t.ELEOFFID===a){t.children.push(e);return}t.children&&w(t.children,e,a)}}const k=(n,e)=>p.value?e.ELEOFFNAME.includes(p.value):!0,m=n=>{const e=new Date(n),a=e.getFullYear(),t=(e.getMonth()+1).toString().padStart(2,"0"),r=e.getDate().toString().padStart(2,"0"),l=e.getHours().toString().padStart(2,"0"),s=e.getMinutes().toString().padStart(2,"0"),o=e.getSeconds().toString().padStart(2,"0");return`${a}-${t}-${r}T${l}:${s}:${o}Z`};async function I(){if(d.value||!L.value)return;const n=R.get("Token");d.value=!0;try{const e=m(N.value[0]),a=m(N.value[1]),t=i.currentPage,r=i.pageSize,l=await ue({deviceType:"-1",dataType:"0",mlineid:L.value,sTime:e,eTime:a,page:String(t),pageSize:String(r),token:n,netMlineid:S.value});if(l.Code===1){const s=JSON.parse(l.Message);g.value=s.map(o=>({MLNAME:o.MLNAME,ElepoName:o.ElepoName,WORKID:o.WORKID,GPSTIME:o.EN_GPS===0?o.DBTIME.replace("T"," "):o.GPSTIME.replace("T"," "),SLTYPE:o.SLTYPE===1?"A相":o.SLTYPE===2?"B相":o.SLTYPE===3?"C相":"未知类型",AEV:o.AEV,VolEvel:o.VolEvel,BATVOL:o.BATVOL,TA:o.TA,RH:o.RH,ENOISE:o.ENOISE,EN_GPS:o.EN_GPS,GPSCN:o.GPSCN,PST:o.PST,SIGNAL4G1:o.SIGNAL4G1,SIGNAL4G2:o.SIGNAL4G2,LINK4GSTATE1:o.LINK4GSTATE1,LINK4GSTATE2:o.LINK4GSTATE2,CT:o.CT,DTUID:o.DTUID,CO_SCALE:o.CO_SCALE,P:o.P,Q:o.Q,POWERFACTOR:o.POWERFACTOR,FREQUENCY:o.FREQUENCY,DBTIME:o.DBTIME,Total:o.Total})),i.total=s.length>0?s[0].Total:0}else console.error("getPowerLineInfo: unexpected response format",l),i.total=0}catch(e){console.error("getPowerLineInfo: error fetching data",e),i.total=0}finally{d.value=!1}}function z(){i.currentPage=1,I()}function B(n){i.pageSize=n,i.currentPage=1,I()}function U(n){i.currentPage=n,L.value&&I()}function Y(n){d.value||n.ELEOFFID&&n.ELEOFFID.startsWith("E")||(L.value=n.ELEOFFID,n.NETMLINEID===void 0?S.value="":S.value=n.NETMLINEID,I())}Q(()=>{A(u.value),y()}),j([N,i],()=>{I()},{deep:!0});const K=()=>{D.value&&D.value.filter(p.value)};function J({column:n,prop:e,order:a}){a&&(d.value=!0,g.value=[...g.value].sort((t,r)=>a==="ascending"?t[e]>r[e]?1:t[e]<r[e]?-1:0:t[e]<r[e]?1:t[e]>r[e]?-1:0),d.value=!1)}return(n,e)=>{const a=h("el-input"),t=h("el-icon"),r=h("el-date-picker"),l=h("el-table-column"),s=h("el-table"),o=h("el-pagination"),$=X("loading");return _(),Z("div",de,[T("div",fe,[c(a,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=f=>p.value=f),placeholder:"输入关键字进行搜索",onInput:K,"prefix-icon":v(ee),clearable:"true",class:"searchStyle"},null,8,["modelValue","prefix-icon"]),c(v(re),{data:u.value,props:V,"filter-node-method":k,ref_key:"treeRef",ref:D,"show-checkbox":!1,"default-expand-all":!0,"highlight-current":!0,onNodeClick:Y},{default:M(({node:f,data:ge})=>[T("span",null,[te(ae(f.label)+" ",1),f.data.IsPELEOFFID?(_(),G(t,{key:0,size:14},{default:M(()=>[c(v(ne),{style:{width:"1em",height:"1em","margin-right":"8px",color:"white"}})]),_:1})):oe("",!0)])]),_:1},8,["data"])]),T("div",he,[T("div",pe,[c(r,{"popper-class":"DataStyle",class:"el-date",modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=f=>N.value=f),type:"daterange","unlink-panels":"true","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:z},null,8,["modelValue"])]),q((_(),G(s,{data:g.value,onSortChange:J,"empty-text":"暂无数据"},{default:M(()=>[c(l,{prop:"MLNAME",label:"线路名称"}),c(l,{prop:"ElepoName",label:"安装塔杆"}),c(l,{prop:"SLTYPE",label:"相别",width:"80px"}),c(l,{prop:"DTUID",label:"终端编号"}),c(l,{prop:"GPSTIME",label:"GPS时间",width:"200px",sortable:"custom"}),c(l,{prop:"AEV",label:"电流有效值"}),c(l,{prop:"VolEvel",label:"电压等级"}),c(l,{prop:"BATVOL",label:"电池电压V"}),c(l,{prop:"TA",label:"温度环境"}),c(l,{prop:"RH",label:"湿度环境"})]),_:1},8,["data"])),[[$,d.value]]),c(o,{onSizeChange:B,onCurrentChange:U,"current-page":i.currentPage,"page-sizes":[10,20,30,40],"page-size":i.pageSize,layout:"prev, pager, next, jumper, ->, sizes, total",total:i.total,"pager-count":3},null,8,["current-page","page-size","total"])])])}}}),Se=le(Ne,[["__scopeId","data-v-358e4481"]]);export{Se as default};
